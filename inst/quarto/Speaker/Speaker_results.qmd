```{=typst}
#let today = datetime.today()
#set page(
  header: [
    #smallcaps[Speaker App]
    #h(1fr) #today.year()
  ],
  footer: [
    #link("https://speaker.swiss-equestrian.info")[speaker.swiss-equestrian.info]
    #h(1fr) #counter(page).display("1")
  ]
)

#show heading.where(level: 1): it => block(
  fill: rgb("#a3be8c"),
  width: 100%,
  radius: 4pt,
  inset: 8pt,
  align(center, it.body)
  
)

#block(
  inset: 8pt,
  radius: 4pt,
  stroke: .5pt,
  [
```


```{r}
#| echo: false
#| output: asis


if("startnummer" %in% colnames(starter)) {
  title <- glue::glue("## N°{starter$startnummer} -- {starter$reiter_name}")
} else {
  title <- glue::glue("## {starter$reiter_name}")
}

cat(title)
```


### Cheval

```{r}
#| echo: false

starter_horses |> 
  rsvps::get_fnch_sp_horse_origins(pdf = TRUE) |> 
  tinytable::tt(width = c(.25, .25, .25, .25)) |> 
  tinytable::theme_tt("striped") |> 
  tinytable::style_tt(align = "l")
```

```{r}
#| echo: false
#| output: asis

titles |>
  dplyr::filter(Licence == starter$reiter_id) -> rider_titles

if (nrow(rider_titles) > 0) {
  cat("### Titres")
}
```

```{r}
#| echo: false

if (nrow(rider_titles) > 0) {
  rider_titles |>
    dplyr::mutate(horse = purrr::map(Passeport, rsvps::get_fnch_horse_infos)) |>
    tidyr::hoist(horse, Cheval = list("name")) |>
    dplyr::select(Lieu, Date, Niveau, `Catégorie`, Cheval, Rang) |> 
    tinytable::tt(width = c(.2, .2, .15, .15, .2, .1)) |> 
    tinytable::theme_tt("striped") |> 
    tinytable::style_tt(align = "l")
}
```


### Résultats

```{r}
#| echo: false

results |>
  dplyr::filter(reiter_id == starter[["reiter_id"]]) |>
  rsvps::get_fnch_sp_fixed_results(discipline) |>
  dplyr::rowwise() |>
  dplyr::filter(any(pferd_id %in% starter[["pferd_id"]])) |>
  rsvps::get_fnch_sp_clean_results(discipline) -> horse_results

if (discipline == "jumping") {
  column_widths <- c(.25, .3, .15, .2, .1)
} else {
  column_widths <- c(.3, .3, .25, .15)
}

if (nrow(horse_results) > 0) {
  horse_results |> 
    tinytable::tt(width = column_widths) |> 
    tinytable::theme_tt("striped") |> 
    tinytable::style_tt(align = "l")
} else {
  cat("Pas de résultats !")
}
```

```{=typst}
  ])
#v(0.5cm)
```

